<script>
    (function() {
        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = Math.random().toString(36).substring(2);
            localStorage.setItem('sessionId', sessionId);
        }

        function logDataStatus(data, context) {
            console.log(`Verificando dados antes de ${context}:`, data);
            if (!data.sessionId || !data.userAgent || !data.url || !data.timestamp) {
                console.error(`Dados faltando antes de ${context}`, data);
            }
        }

        function collectData() {
            const data = {
                sessionId: sessionId,
                userAgent: navigator.userAgent,
                referrer: document.referrer || 'N/A',
                url: window.location.href,
                timestamp: new Date().toISOString(),
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                deviceType: /Mobi|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                loadTime: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart
            };

            logDataStatus(data, "enviar para /collect-data");

            if (data.sessionId && data.userAgent && data.url && data.timestamp) {
                console.log('Dados a serem enviados:', data);

                fetch('https://encapsul-id.onrender.com/collect-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(jsonResponse => {
                    console.log('Resposta recebida do servidor:', jsonResponse);
                    if (jsonResponse.sessionId) {
                        sessionId = jsonResponse.sessionId;
                        localStorage.setItem('sessionId', sessionId);
                    }
                })
                .catch(error => console.error('Erro ao enviar dados:', error));
            }
        }

        window.addEventListener('load', () => {
            collectData();
        });

        let startTime = new Date();
        window.addEventListener('beforeunload', () => {
            const duration = new Date() - startTime;

            const data = {
                sessionId: sessionId,
                duration: duration,
                userAgent: navigator.userAgent,
                url: window.location.href,
                timestamp: new Date().toISOString()
            };

            logDataStatus(data, "enviar para /session-duration");

            if (data.sessionId && data.userAgent && data.url && data.timestamp) {
                navigator.sendBeacon('https://encapsul-id.onrender.com/session-duration', JSON.stringify(data));
            }
        });

        document.addEventListener('click', () => {
            const data = {
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };

            logDataStatus(data, "enviar para /capture-click");

            if (data.sessionId && data.userAgent && data.url && data.timestamp) {
                fetch('https://encapsul-id.onrender.com/capture-click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .catch(error => console.error('Erro ao enviar clique:', error));
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const data = {
                sessionId: sessionId,
                url: window.location.href,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };

            logDataStatus(data, "enviar para /page-visit");

            if (data.sessionId && data.userAgent && data.url && data.timestamp) {
                fetch('https://encapsul-id.onrender.com/page-visit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .catch(error => console.error('Erro ao enviar p√°gina visitada:', error));
            }
        });
    })();
</script>
